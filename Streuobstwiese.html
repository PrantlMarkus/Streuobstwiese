<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Streuobst-Wiese</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- Bibliothek für das QR-Code-Scannen über die Kamera -->
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #e2e8f0;
        }

        .scroll-container::-webkit-scrollbar {
            width: 8px;
        }

        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #94a3b8;
            border-radius: 4px;
        }

        .scroll-container::-webkit-scrollbar-track {
            background-color: #f1f5f9;
        }

        .clickable-heading {
            cursor: pointer;
            transition: color 0.2s ease-in-out;
        }

        .clickable-heading:hover {
            color: #16a34a; /* Tailwind's green-600 */
        }
    </style>
</head>

<body class="bg-gray-200 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white p-8 rounded-2xl shadow-xl max-w-lg w-full">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-2">Streuobst-Wiese</h1>
        <p class="text-center text-gray-500 mb-6">Gasoid - Fieberbrunn</p>

        <!-- Ladezustand und Fehlermeldungen -->
        <div id="loadingIndicator" class="text-center py-4 hidden">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto"></div>
        </div>
        <div id="statusMessage" class="text-center py-4 hidden text-red-500"></div>

        <!-- App Container -->
        <div id="app" class="space-y-6 hidden">

            <!-- Baum-Liste Ansicht -->
            <div id="treeListSection">
                <button id="scanQrButton" class="w-full bg-blue-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-blue-700 transition-colors mb-4">
                    QR scannen
                </button>
                <button id="addTreeButton" class="w-full bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                    Baum hinzufügen
                </button>

                <div class="bg-gray-100 p-4 rounded-lg mt-6 shadow-inner">
                    <h2 class="text-xl font-semibold text-gray-700 mb-4">Obstbäume</h2>
                    <div id="treesContainer" class="space-y-4 max-h-96 overflow-y-auto scroll-container">
                        <p class="text-gray-500 text-center">Lade Bäume...</p>
                    </div>
                </div>
            </div>

            <!-- Notizen Ansicht (initially hidden) -->
            <div id="notesSection" class="hidden">
                <button id="backButton" class="bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-400 transition-colors mb-4">
                    ← Zurück
                </button>
                
                <div class="flex items-center space-x-4 mb-4">
                    <div id="qrNotesContainer" class="p-2 bg-white rounded-lg cursor-pointer"></div>
                    <div>
                        <h2 id="treeNameHeading" class="text-2xl font-bold text-gray-800 clickable-heading"></h2>
                        <p id="treeVarietyHeading" class="text-lg font-semibold text-green-600 clickable-heading"></p>
                    </div>
                </div>

                <form id="noteForm" class="flex flex-col space-y-4 mt-6">
                    <textarea id="noteInput" placeholder="Notiz hier eingeben (z.B. 'Befall von Blattläusen')..."
                        class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow"></textarea>
                    <button type="submit"
                        class="bg-green-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-green-700 transition-colors">
                        Notiz hinzufügen
                    </button>
                </form>

                <div class="bg-gray-100 p-4 rounded-lg mt-6 shadow-inner">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Chronik der Notizen</h3>
                    <div id="notesContainer" class="space-y-3 max-h-64 overflow-y-auto scroll-container">
                        <p class="text-gray-500 text-center">Keine Notizen vorhanden.</p>
                    </div>
                </div>
                <!-- Neuer Button für die KI-Analyse -->
                <button id="analyzeButton" class="w-full mt-4 bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md hover:bg-gray-700 transition-colors">
                    Notizen analysieren (KI)
                </button>
            </div>
        </div>

        <!-- Bestätigungs-Modal -->
        <div id="confirmationModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h2 id="modalTitle" class="text-xl font-bold mb-4">Bestätigung erforderlich</h2>
                <p id="modalMessage" class="text-gray-700 mb-6"></p>
                <div class="flex justify-end space-x-4">
                    <button id="cancelButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Abbrechen
                    </button>
                    <button id="confirmButton" class="px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                        Ja, löschen
                    </button>
                </div>
            </div>
        </div>

        <!-- Baum hinzufügen/bearbeiten Modal -->
        <div id="addTreeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-40 hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-sm w-full">
                <h2 class="text-xl font-bold mb-4">Neuen Baum hinzufügen</h2>
                <form id="treeForm" class="flex flex-col space-y-4">
                    <div class="flex space-x-4">
                        <input type="number" id="treeRowInput" placeholder="Reihe"
                            class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow w-1/2">
                        <input type="number" id="treeNumberInput" placeholder="Nr."
                            class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow w-1/2">
                    </div>
                    <input type="text" id="treeNameInput" placeholder="Name des Baumes (z.B. Apfel)"
                        class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow">
                    <input type="text" id="treeVarietyInput" placeholder="Sorte (z.B. Elstar)"
                        class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 transition-shadow">
                    <div class="flex justify-end space-x-4 mt-4">
                        <button type="button" id="cancelAddTreeButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                            Abbrechen
                        </button>
                        <button type="submit" id="saveTreeButton" class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition-colors">
                            Speichern
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- QR-Scan Modal -->
        <div id="qrScanModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex flex-col items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full text-center">
                <h2 class="text-xl font-bold mb-4">QR-Code scannen</h2>
                <div id="qr-reader" class="w-full"></div>
                <div id="qr-reader-results" class="mt-4 text-sm text-gray-500"></div>
                <button id="closeQrScannerButton" class="mt-6 px-4 py-2 bg-red-600 text-white rounded-lg font-semibold hover:bg-red-700 transition-colors">
                    Abbrechen
                </button>
            </div>
        </div>

        <!-- KI-Analyse Modal -->
        <div id="analysisModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
            <div class="bg-white rounded-lg p-6 shadow-xl max-w-lg w-full">
                <h2 class="text-xl font-bold mb-4">KI-Analyse der Notizen</h2>
                <div id="analysisContent" class="text-gray-700 max-h-96 overflow-y-auto scroll-container mb-6 leading-relaxed">
                    <!-- Inhalt wird hier eingefügt -->
                </div>
                <div class="flex justify-end">
                    <button id="closeAnalysisModalButton" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg font-semibold hover:bg-gray-300 transition-colors">
                        Schließen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase-Skripte und Anwendungslogik -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserSessionPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, where, serverTimestamp, doc, deleteDoc, getDocs, writeBatch, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // FIREBASE-KONFIGURATION FÜR DIE PERMANENTE DATENBANK DES BENUTZERS
        const firebaseConfig = {
            apiKey: "AIzaSyDrEvVolCn5EvBxGOfpuGQLTEAYUEKcCMk",
            authDomain: "streuobstwiese-82e27.firebaseapp.com",
            projectId: "streuobstwiese-82e27",
            storageBucket: "streuobstwiese-82e27.appspot.com",
            messagingSenderId: "395164081126",
            appId: "1:395164081126:web:YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        let app, db, auth;
        let userId;
        let selectedTreeId = null;
        let unsubscribeNotes = null;
        let isEditing = false;
        let treeIdToEdit = null;

        const loadingIndicator = document.getElementById('loadingIndicator');
        const statusMessage = document.getElementById('statusMessage');
        const appContainer = document.getElementById('app');
        const treeListSection = document.getElementById('treeListSection');
        const notesSection = document.getElementById('notesSection');
        const treesContainer = document.getElementById('treesContainer');
        const backButton = document.getElementById('backButton');
        const qrNotesContainer = document.getElementById('qrNotesContainer');
        const treeNameHeading = document.getElementById('treeNameHeading');
        const treeVarietyHeading = document.getElementById('treeVarietyHeading');
        const noteForm = document.getElementById('noteForm');
        const noteInput = document.getElementById('noteInput');
        const notesContainer = document.getElementById('notesContainer');

        const confirmationModal = document.getElementById('confirmationModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalMessage = document.getElementById('modalMessage');
        const confirmButton = document.getElementById('confirmButton');
        const cancelButton = document.getElementById('cancelButton');
        
        // Neue Elemente für das Baum-Hinzufügen-Modal
        const addTreeButton = document.getElementById('addTreeButton');
        const addTreeModal = document.getElementById('addTreeModal');
        const treeForm = document.getElementById('treeForm');
        const treeRowInput = document.getElementById('treeRowInput');
        const treeNumberInput = document.getElementById('treeNumberInput');
        const treeNameInput = document.getElementById('treeNameInput');
        const treeVarietyInput = document.getElementById('treeVarietyInput');
        const cancelAddTreeButton = document.getElementById('cancelAddTreeButton');
        const saveTreeButton = document.getElementById('saveTreeButton');

        // Neue Elemente für den QR-Scanner
        const scanQrButton = document.getElementById('scanQrButton');
        const qrScanModal = document.getElementById('qrScanModal');
        const qrReader = document.getElementById('qr-reader');
        const closeQrScannerButton = document.getElementById('closeQrScannerButton');
        let html5QrCode;

        // Neue Elemente für die KI-Analyse
        const analyzeButton = document.getElementById('analyzeButton');
        const analysisModal = document.getElementById('analysisModal');
        const analysisContent = document.getElementById('analysisContent');
        const closeAnalysisModalButton = document.getElementById('closeAnalysisModalButton');

        // Define an array of subtle background colors
        const backgroundColors = [
            '#f0f9ff', // light cyan
            '#f0fdf4', // light emerald
            '#fefce8', // light yellow
            '#f1f5f9', // light slate
            '#f3e8ff', // light violet
            '#fee2e2' // light red
        ];

        function showLoading(show) {
            loadingIndicator.classList.toggle('hidden', !show);
            appContainer.classList.toggle('hidden', show);
        }

        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.classList.remove('hidden', 'text-red-500', 'text-green-500');
            statusMessage.classList.add(isError ? 'text-red-500' : 'text-green-500');
            statusMessage.classList.toggle('hidden', false);
        }

        async function initializeAppAndAuth() {
            showLoading(true);
            try {
                setLogLevel('debug');
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                await setPersistence(auth, browserSessionPersistence);
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        showLoading(false);
                        appContainer.classList.remove('hidden');
                        showStatus('Erfolgreich verbunden!', false);
                        setupTreesListener();
                    } else {
                        showStatus('Fehler bei der Authentifizierung.', true);
                    }
                });
            } catch (error) {
                console.error("Fehler bei der Initialisierung:", error);
                showStatus(`Fehler: ${error.message}`, true);
                showLoading(false);
            }
        }

        // Funktion zum Anzeigen eines einfachen Alert-Modals
        function showAlertDialog(message) {
            modalTitle.textContent = 'Fehler';
            modalMessage.textContent = message;
            confirmButton.textContent = 'OK';
            confirmButton.classList.remove('bg-red-600', 'hover:bg-red-700');
            confirmButton.classList.add('bg-gray-600', 'hover:bg-gray-700');
            cancelButton.classList.add('hidden');
            confirmationModal.classList.remove('hidden');

            const confirmHandler = () => {
                confirmationModal.classList.add('hidden');
                confirmButton.removeEventListener('click', confirmHandler);
                // Setzt die Button-Zustände zurück
                confirmButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
                confirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            };
            confirmButton.addEventListener('click', confirmHandler);
        }
        
        // Funktion zum Anzeigen des Bestätigungs-Modals
        function showConfirmationModal(message, onConfirm) {
            modalTitle.textContent = 'Bestätigung erforderlich';
            modalMessage.textContent = message;
            confirmButton.textContent = 'Ja, löschen';
            confirmButton.classList.add('bg-red-600', 'hover:bg-red-700');
            confirmButton.classList.remove('bg-gray-600', 'hover:bg-gray-700');
            cancelButton.classList.remove('hidden');
            confirmationModal.classList.remove('hidden');
            
            // Event-Listener für die Buttons
            const confirmHandler = () => {
                confirmationModal.classList.add('hidden');
                onConfirm();
                confirmButton.removeEventListener('click', confirmHandler);
                cancelButton.removeEventListener('click', cancelHandler);
            };
            const cancelHandler = () => {
                confirmationModal.classList.add('hidden');
                cancelButton.removeEventListener('click', cancelHandler);
                confirmButton.removeEventListener('click', confirmHandler);
            };

            confirmButton.addEventListener('click', confirmHandler);
            cancelButton.addEventListener('click', cancelHandler);
        }

        // Baum-Ansicht anzeigen und Notizen-Ansicht ausblenden
        function showTreeListView() {
            treeListSection.classList.remove('hidden');
            notesSection.classList.add('hidden');
            if (unsubscribeNotes) {
                unsubscribeNotes();
                unsubscribeNotes = null;
            }
        }

        // Notizen-Ansicht anzeigen
        function showNotesView(tree) {
            treeListSection.classList.add('hidden');
            notesSection.classList.remove('hidden');
            
            // Setzt die Überschriften basierend auf Name und Sorte
            treeNameHeading.textContent = tree.name;
            treeVarietyHeading.textContent = tree.variety;

            selectedTreeId = tree.id;
            qrNotesContainer.innerHTML = '';
            
            // Fügt Klick-Listener für die Bearbeitung hinzu
            const editClickHandler = () => openEditTreeModal(tree);
            treeNameHeading.addEventListener('click', editClickHandler);
            treeVarietyHeading.addEventListener('click', editClickHandler);

            // Generiert den QR-Code als Canvas
            const qrcode = new QRCode(qrNotesContainer, {
                text: tree.id,
                width: 100,
                height: 100,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Ereignis-Listener für den QR-Code, um das Druckfenster zu öffnen
            qrNotesContainer.addEventListener('click', () => {
                const qrCanvas = qrNotesContainer.querySelector('canvas');
                if (qrCanvas) {
                    const dataUrl = qrCanvas.toDataURL();
                    const printWindow = window.open('', '_blank');
                    printWindow.document.write(`
                        <html>
                        <head>
                            <title>QR-Code für ${tree.name} - ${tree.variety}</title>
                            <style>
                                body { text-align: center; }
                            </style>
                        </head>
                        <body>
                            <img src="${dataUrl}" style="max-width: 100%;">
                            <h1>${tree.name} - ${tree.variety}</h1>
                        </body>
                        </html>
                    `);
                    printWindow.document.close();
                    printWindow.focus();
                    
                    // Der Timeout stellt sicher, dass der Inhalt geladen ist, bevor gedruckt wird
                    setTimeout(() => {
                        printWindow.print();
                        printWindow.onafterprint = () => printWindow.close();
                    }, 500);
                }
            });

            setupNotesListener(tree.id);
        }
        
        // Funktion zum Abrufen eines Baumes und Anzeigen der Notizen
        async function fetchAndShowNotesForTree(treeId) {
            showLoading(true);
            try {
                const treeDocRef = doc(db, 'streuobst_wiese', treeId);
                const treeSnap = await getDoc(treeDocRef);
                
                if (treeSnap.exists()) {
                    showLoading(false);
                    const treeData = { id: treeSnap.id, ...treeSnap.data() };
                    showNotesView(treeData);
                } else {
                    showLoading(false);
                    showAlertDialog('Kein Baum mit diesem QR-Code gefunden.');
                }
            } catch (error) {
                showLoading(false);
                console.error("Fehler beim Abrufen des Baumes:", error);
                showAlertDialog(`Fehler beim Laden des Baumes: ${error.message}`);
            }
        }

        // Listener für Echtzeit-Updates von Bäumen
        function setupTreesListener() {
            try {
                const treesCollectionRef = collection(db, 'streuobst_wiese');
                const q = query(treesCollectionRef);

                onSnapshot(q, async (querySnapshot) => {
                    treesContainer.innerHTML = '';
                    const trees = [];
                    querySnapshot.forEach((doc) => {
                        const treeData = doc.data();
                        trees.push({ id: doc.id, ...treeData });
                    });

                    if (trees.length === 0) {
                        treesContainer.innerHTML = '<p class="text-gray-500 text-center">Keine Bäume vorhanden.</p>';
                    } else {
                        trees.sort((a, b) => {
                            const rowA = a.row || 0;
                            const rowB = b.row || 0;
                            const numA = a.number || 0;
                            const numB = b.number || 0;

                            if (rowA !== rowB) {
                                return rowA - rowB;
                            }
                            return numA - numB;
                        });
                        
                        trees.forEach(tree => {
                            const treeElement = document.createElement('div');
                            treeElement.classList.add('p-4', 'bg-white', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'flex', 'items-start', 'space-x-4', 'cursor-pointer', 'hover:bg-gray-50', 'transition-colors');
                            
                            // Farbliche Hervorhebung pro Reihe
                            const colorIndex = (tree.row - 1) % backgroundColors.length;
                            treeElement.style.backgroundColor = backgroundColors[colorIndex];
                            
                            treeElement.dataset.treeId = tree.id;
                            treeElement.dataset.treeName = tree.name;
                            
                            const textContainer = document.createElement('div');
                            textContainer.classList.add('flex-grow');

                            const treeLocation = document.createElement('div');
                            treeLocation.classList.add('flex', 'space-x-4', 'font-bold', 'text-gray-800', 'mb-2');
                            treeLocation.innerHTML = `<span>Reihe: ${tree.row || '-'}</span><span>Nr.: ${tree.number || '-'}</span>`;

                            const nameText = document.createElement('p');
                            nameText.classList.add('font-bold', 'text-gray-800');
                            nameText.textContent = `Name: ${tree.name}`;
                            const varietyText = document.createElement('p');
                            varietyText.classList.add('text-gray-600');
                            varietyText.textContent = `Sorte: ${tree.variety}`;
                            
                            textContainer.appendChild(treeLocation);
                            textContainer.appendChild(nameText);
                            textContainer.appendChild(varietyText);
                            treeElement.appendChild(textContainer);

                            const deleteButton = document.createElement('button');
                            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>`;
                            deleteButton.classList.add('p-2', 'bg-red-500', 'text-white', 'rounded-full', 'shadow', 'hover:bg-red-600', 'transition-colors');
                            deleteButton.addEventListener('click', async (e) => {
                                e.stopPropagation(); // Verhindert, dass der Klick das Notizfenster öffnet
                                showConfirmationModal('Sind Sie sicher, dass Sie diesen Baum und alle dazugehörigen Notizen löschen möchten?', async () => {
                                    try {
                                        // Löschen aller Notizen für diesen Baum
                                        const notesRef = collection(db, 'streuobst_wiese', tree.id, 'notizen');
                                        const notesSnapshot = await getDocs(notesRef);
                                        const batch = writeBatch(db);
                                        notesSnapshot.docs.forEach(noteDoc => {
                                            batch.delete(noteDoc.ref);
                                        });
                                        await batch.commit();

                                        // Löschen des Baums selbst
                                        const treeDocRef = doc(db, 'streuobst_wiese', tree.id);
                                        await deleteDoc(treeDocRef);
                                        showStatus('Baum und Notizen erfolgreich gelöscht.', false);
                                    } catch (error) {
                                        console.error("Fehler beim Löschen des Baumes:", error);
                                        showStatus(`Fehler beim Löschen: ${error.message}`, true);
                                    }
                                });
                            });
                            treeElement.appendChild(deleteButton);

                            treesContainer.appendChild(treeElement);

                            // Klick-Listener für jeden Baum
                            treeElement.addEventListener('click', () => {
                                showNotesView(tree);
                            });
                        });
                    }
                }, (error) => {
                    console.error("Fehler beim Abrufen der Bäume:", error);
                    showStatus(`Fehler beim Laden der Bäume: ${error.message}`, true);
                });
            } catch (error) {
                console.error("Fehler beim Einrichten des Listeners:", error);
                showStatus(`Fehler beim Einrichten des Listeners: ${error.message}`, true);
            }
        }

        // Listener für Echtzeit-Updates von Notizen
        function setupNotesListener(treeId) {
            try {
                const notesCollectionRef = collection(db, 'streuobst_wiese', treeId, 'notizen');
                const q = query(notesCollectionRef);

                if (unsubscribeNotes) {
                    unsubscribeNotes();
                }

                unsubscribeNotes = onSnapshot(q, (querySnapshot) => {
                    notesContainer.innerHTML = '';
                    const notes = [];
                    querySnapshot.forEach((doc) => {
                        const noteData = doc.data();
                        notes.push({ id: doc.id, ...noteData });
                    });

                    if (notes.length === 0) {
                        notesContainer.innerHTML = '<p class="text-gray-500 text-center">Keine Notizen vorhanden.</p>';
                    } else {
                        notes.sort((a, b) => {
                            const timeA = a.timestamp?.seconds || 0;
                            const timeB = b.timestamp?.seconds || 0;
                            return timeB - a.timestamp?.seconds;
                        });
                        notes.forEach(note => {
                            const noteElement = document.createElement('div');
                            noteElement.classList.add('p-3', 'bg-white', 'rounded-lg', 'border', 'border-gray-200', 'shadow-sm', 'flex', 'justify-between', 'items-center', 'break-words');
                            const date = note.timestamp ? new Date(note.timestamp.seconds * 1000).toLocaleDateString() : 'Unbekanntes Datum';
                            
                            const textContainer = document.createElement('div');
                            textContainer.classList.add('flex-grow');
                            textContainer.innerHTML = `<p class="text-xs text-gray-400">${date}</p><p class="mt-1">${note.text}</p>`;
                            noteElement.appendChild(textContainer);

                            const deleteButton = document.createElement('button');
                            deleteButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm6 0a1 1 0 11-2 0v6a1 1 0 112 0V8z" clip-rule="evenodd" />
                            </svg>`;
                            deleteButton.classList.add('ml-4', 'p-1', 'bg-red-500', 'text-white', 'rounded-full', 'shadow', 'hover:bg-red-600', 'transition-colors');
                            deleteButton.addEventListener('click', async () => {
                                showConfirmationModal('Sind Sie sicher, dass Sie diese Notiz löschen möchten?', async () => {
                                    try {
                                        const noteDocRef = doc(db, 'streuobst_wiese', treeId, 'notizen', note.id);
                                        await deleteDoc(noteDocRef);
                                        showStatus('Notiz erfolgreich gelöscht.', false);
                                    } catch (error) {
                                        console.error("Fehler beim Löschen der Notiz:", error);
                                        showStatus(`Fehler beim Speichern der Notiz: ${error.message}`, true);
                                    }
                                });
                            });
                            noteElement.appendChild(deleteButton);
                            notesContainer.appendChild(noteElement);
                        });
                    }
                }, (error) => {
                    console.error("Fehler beim Abrufen der Notizen:", error);
                    showStatus(`Fehler beim Laden der Notizen: ${error.message}`, true);
                });
            } catch (error) {
                console.error("Fehler beim Einrichten des Notizen-Listeners:", error);
                showStatus(`Fehler beim Einrichten des Notizen-Listeners: ${error.message}`, true);
            }
        }

        function resetTreeModal() {
            addTreeModal.classList.add('hidden');
            treeForm.reset();
            isEditing = false;
            treeIdToEdit = null;
            document.querySelector('#addTreeModal h2').textContent = 'Neuen Baum hinzufügen';
            saveTreeButton.textContent = 'Speichern';
        }

        function openEditTreeModal(tree) {
            isEditing = true;
            treeIdToEdit = tree.id;
            document.querySelector('#addTreeModal h2').textContent = 'Baum bearbeiten';
            saveTreeButton.textContent = 'Änderungen speichern';
            treeRowInput.value = tree.row;
            treeNumberInput.value = tree.number;
            treeNameInput.value = tree.name;
            treeVarietyInput.value = tree.variety;
            addTreeModal.classList.remove('hidden');
        }

        // Baum hinzufügen oder bearbeiten
        treeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const row = treeRowInput.value.trim();
            const number = treeNumberInput.value.trim();
            const name = treeNameInput.value.trim();
            const variety = treeVarietyInput.value.trim();
            
            if (row === "" || number === "" || name === "" || variety === "") {
                showStatus('Bitte füllen Sie alle Felder aus.', true);
                return;
            }
            
            try {
                const treesCollectionRef = collection(db, 'streuobst_wiese');
                const q = query(treesCollectionRef, where('row', '==', parseInt(row, 10)), where('number', '==', parseInt(number, 10)));
                const querySnapshot = await getDocs(q);

                if (isEditing) {
                    let duplicateFound = false;
                    querySnapshot.forEach(doc => {
                        if (doc.id !== treeIdToEdit) {
                            duplicateFound = true;
                        }
                    });

                    if (duplicateFound) {
                        showAlertDialog('Ein anderer Baum mit dieser Reihe und Nummer existiert bereits. Bitte wählen Sie eine andere Kombination.');
                        return;
                    }
                    
                    const treeDocRef = doc(db, 'streuobst_wiese', treeIdToEdit);
                    await setDoc(treeDocRef, {
                        row: parseInt(row, 10),
                        number: parseInt(number, 10),
                        name: name,
                        variety: variety
                    }, { merge: true }); // 'merge: true' verhindert, dass Notizen überschrieben werden
                    showStatus('Baum erfolgreich aktualisiert.', false);
                } else {
                    if (!querySnapshot.empty) {
                        showAlertDialog('Ein Baum mit dieser Reihe und Nummer existiert bereits.');
                        return;
                    }
                    
                    // Neuen Baum hinzufügen
                    await addDoc(treesCollectionRef, {
                        row: parseInt(row, 10),
                        number: parseInt(number, 10),
                        name: name,
                        variety: variety,
                        timestamp: serverTimestamp(),
                        owner: userId
                    });
                    showStatus('Baum erfolgreich hinzugefügt.', false);
                }
                
                resetTreeModal();
            } catch (error) {
                console.error("Fehler beim Speichern des Baumes:", error);
                showStatus(`Fehler beim Speichern: ${error.message}`, true);
            }
        });

        // Notiz hinzufügen
        noteForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const noteText = noteInput.value.trim();
            
            if (noteText === "") {
                showStatus('Bitte geben Sie eine Notiz ein.', true);
                return;
            }

            if (!selectedTreeId) {
                showStatus('Kein Baum ausgewählt.', true);
                return;
            }

            try {
                const notesCollectionRef = collection(db, 'streuobst_wiese', selectedTreeId, 'notizen');
                await addDoc(notesCollectionRef, {
                    text: noteText,
                    timestamp: serverTimestamp(),
                    owner: userId
                });
                noteInput.value = '';
                showStatus('Notiz erfolgreich hinzugefügt.', false);
            } catch (error) {
                console.error("Fehler beim Hinzufügen der Notiz:", error);
                showStatus(`Fehler beim Speichern der Notiz: ${error.message}`, true);
            }
        });

        // Event-Listener für die neuen Buttons
        addTreeButton.addEventListener('click', () => {
            resetTreeModal(); // Stellt sicher, dass der Modal-Zustand korrekt für Hinzufügen ist
            addTreeModal.classList.remove('hidden');
        });

        cancelAddTreeButton.addEventListener('click', resetTreeModal);

        backButton.addEventListener('click', showTreeListView);

        // QR-Scan-Logik
        scanQrButton.addEventListener('click', async () => {
            qrScanModal.classList.remove('hidden');
            if (html5QrCode) {
                await html5QrCode.stop().catch(err => console.error("Fehler beim Stoppen des Scanners:", err));
            }
            html5QrCode = new Html5Qrcode("qr-reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config,
                async (decodedText, decodedResult) => {
                    // Erfolg: QR-Code erkannt
                    await html5QrCode.stop();
                    qrScanModal.classList.add('hidden');
                    
                    // Überprüfen, ob der gescannte Text eine gültige Baum-ID ist
                    if (decodedText && decodedText.length > 0) {
                        fetchAndShowNotesForTree(decodedText);
                    } else {
                        showAlertDialog('Ungültiger QR-Code gescannt.');
                    }
                },
                (errorMessage) => {
                    // Fehler: Kein QR-Code im Bild gefunden, wird kontinuierlich aufgerufen
                    // Ist okay, muss nicht geloggt werden
                })
                .catch((err) => {
                    // Fehler: Kamera nicht verfügbar oder Berechtigung verweigert
                    qrScanModal.classList.add('hidden');
                    console.error("Kamera-Fehler:", err);
                    showAlertDialog(`Fehler beim Starten der Kamera: ${err.message}`);
                });
        });

        closeQrScannerButton.addEventListener('click', async () => {
            qrScanModal.classList.add('hidden');
            if (html5QrCode) {
                await html5QrCode.stop().catch(err => console.error("Fehler beim Stoppen des Scanners:", err));
            }
        });

        // Event-Listener für den neuen Analyse-Button
        analyzeButton.addEventListener('click', async () => {
            if (!selectedTreeId) {
                showAlertDialog('Kein Baum ausgewählt, um Notizen zu analysieren.');
                return;
            }
            await analyzeNotesWithAI();
        });

        // Schließen des KI-Analyse-Modals
        closeAnalysisModalButton.addEventListener('click', () => {
            analysisModal.classList.add('hidden');
        });

        // Funktion zur Anzeige des Analyse-Modals
        function showAnalysisModal(content) {
            analysisContent.innerHTML = content.replace(/\n/g, '<br>'); // Zeilenumbrüche für HTML
            analysisModal.classList.remove('hidden');
        }

        // Funktion zur Analyse der Notizen mit KI
        async function analyzeNotesWithAI() {
            showLoading(true);
            try {
                const notesCollectionRef = collection(db, 'streuobst_wiese', selectedTreeId, 'notizen');
                const querySnapshot = await getDocs(notesCollectionRef);
                
                if (querySnapshot.empty) {
                    showLoading(false);
                    showAlertDialog('Keine Notizen für diesen Baum zum Analysieren gefunden.');
                    return;
                }
                
                const notes = [];
                querySnapshot.forEach(doc => {
                    const noteData = doc.data();
                    const date = noteData.timestamp ? new Date(noteData.timestamp.seconds * 1000).toLocaleDateString('de-DE') : 'Datum unbekannt';
                    notes.push(`- [${date}] ${noteData.text}`);
                });

                const allNotesText = notes.join('\n');
                
                // Wir fassen System-Prompt und Benutzerabfrage zusammen, um das API-Verhalten zu stabilisieren.
                const combinedPrompt = `Sie sind ein erfahrener Gärtner und Obstbaumspezialist. Analysieren Sie die bereitgestellten Notizen für einen Obstbaum. Geben Sie eine prägnante Zusammenfassung der wichtigsten Beobachtungen und identifizieren Sie potenzielle Probleme oder empfohlene Maßnahmen. Schreiben Sie als wäre es eine kurze, professionelle Beurteilung.
                
                Analysiere die folgenden Notizen:\n\n${allNotesText}`;
                
                const payload = {
                    contents: [{
                        parts: [{ text: combinedPrompt }]
                    }]
                };

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    let errorMessage = `API-Fehler: ${response.statusText}`;
                    if (response.status === 403) {
                        errorMessage = "API-Fehler: Zugriff verweigert. Bitte überprüfen Sie den API-Schlüssel oder die Service-Berechtigungen.";
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const analysisText = candidate.content.parts[0].text;
                    showLoading(false);
                    showAnalysisModal(analysisText);
                } else {
                    showLoading(false);
                    throw new Error('Keine Analyse von der KI erhalten.');
                }

            } catch (error) {
                showLoading(false);
                console.error("Fehler bei der KI-Analyse:", error);
                showAlertDialog(`Fehler bei der Analyse: ${error.message}`);
            }
        }
        
        initializeAppAndAuth();
    </script>
</body>
</html>
